#!/bin/bash
# Complete session closeout workflow with HITL approval
# Stock-first: wraps claude-flow hooks with thin orchestration

set -e

SESSION_ID="${1:-$SESSION_ID}"

if [[ -z "$SESSION_ID" ]]; then
  echo "‚ùå No session ID provided"
  echo "Usage: $0 <session-id>"
  echo "  or: export SESSION_ID=<session-id> && $0"
  exit 1
fi

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

echo "üìä Collecting session data..."
npx claude-flow@alpha hooks post-task --task-id "$SESSION_ID"
echo "‚úì Post-task hook complete"
echo

echo "üìù Generating session summary..."
npx claude-flow@alpha hooks session-end --generate-summary true
echo "‚úì Summary generated"
echo

# Calculate session duration
METADATA="sessions/$SESSION_ID/metadata.json"
if [[ -f "$METADATA" ]] && command -v jq &> /dev/null; then
  START_TIME=$(jq -r '.created_at' "$METADATA")
  if [[ -n "$START_TIME" ]] && [[ "$START_TIME" != "null" ]]; then
    START_EPOCH=$(date -j -f "%Y-%m-%dT%H:%M:%SZ" "$START_TIME" "+%s" 2>/dev/null || echo "0")
    END_EPOCH=$(date "+%s")
    if [[ "$START_EPOCH" != "0" ]]; then
      DURATION_SECONDS=$((END_EPOCH - START_EPOCH))
      HOURS=$((DURATION_SECONDS / 3600))
      MINUTES=$(((DURATION_SECONDS % 3600) / 60))
      echo "‚è±Ô∏è  Session duration: ${HOURS}h ${MINUTES}m"
      echo
    fi
  fi
fi

# Display summary
SUMMARY_FILE="sessions/$SESSION_ID/session-summary.md"
if [[ -f "$SUMMARY_FILE" ]]; then
  echo "=== Session Summary ==="
  cat "$SUMMARY_FILE"
  echo
fi

# HITL Approval
echo "Review the summary above."
read -p "Approve closeout and archive? (y/N): " -n 1 -r
echo

if [[ ! $REPLY =~ ^[Yy]$ ]]; then
  echo "‚ùå Closeout cancelled. Session remains active."
  exit 0
fi

# Archive
echo
echo "üì¶ Archiving session..."
npx claude-flow@alpha hooks session-end --export-metrics true
echo "‚úì Backup created in .swarm/backups/"
echo

echo "üìñ Updating Captain's Log..."
# Extract summary for log entry
if [[ -f "$SUMMARY_FILE" ]]; then
  SUMMARY_TEXT=$(head -50 "$SUMMARY_FILE" | tail -30)
  bash .claude/hooks/journal.sh "Session $SESSION_ID closed

$SUMMARY_TEXT" 2>/dev/null || echo "  (Captain's Log update skipped)"
fi
echo "‚úì Captain's Log updated"
echo

echo "üìù Updating metadata..."
# Update metadata status (Patch 3: Mark session as completed)
METADATA="sessions/$SESSION_ID/metadata.json"
if [[ -f "$METADATA" ]]; then
  if command -v jq &> /dev/null; then
    jq --arg closed_at "$(date -u +%Y-%m-%dT%H:%M:%SZ)" \
       '. + {status: "completed", closed_at: $closed_at}' \
       "$METADATA" > "$METADATA.tmp"
    mv "$METADATA.tmp" "$METADATA"
  else
    echo "  (jq not found, metadata update skipped)"
  fi
fi
echo "‚úì Metadata updated to 'completed'"
echo

# Document Promotion Check
echo "üìÑ Checking for user-facing documentation..."
DOCS_DIR="sessions/$SESSION_ID/artifacts/docs"
if [[ -d "$DOCS_DIR" ]]; then
  DOC_COUNT=$(find "$DOCS_DIR" -type f -name "*.md" | wc -l | tr -d ' ')
  if [[ "$DOC_COUNT" -gt 0 ]]; then
    echo "  Found $DOC_COUNT documents in session artifacts"
    echo
    find "$DOCS_DIR" -type f -name "*.md" -exec ls -lh {} \; | awk '{print "    " $9 " (" $5 ")"}'
    echo
    echo "  üìö Routing guide: .claude/skills/file-routing/README.md"
    echo
    read -p "  Promote any docs to docs/guides/? (y/N): " -n 1 -r
    echo
    if [[ $REPLY =~ ^[Yy]$ ]]; then
      echo
      echo "  ‚úÖ Document Promotion Checklist:"
      echo "  1. User-facing guide? (not system/architecture work)"
      echo "  2. Category: getting-started, how-to, reference, troubleshooting, concepts, advanced?"
      echo "  3. Passes 3-question test in file-routing skill?"
      echo
      echo "  üìÅ Target: docs/guides/{category}/{filename}.md"
      echo
      echo "  Pausing closeout - manually promote docs, then run closeout again"
      exit 0
    else
      echo "  ‚úì Skipping document promotion"
    fi
  fi
fi
echo

echo "üîÑ Clearing session environment..."
# Clear active session environment variable (Patch 3: Session Inheritance cleanup)
if [[ -n "$ACTIVE_SESSION_ID" ]] && [[ "$ACTIVE_SESSION_ID" == "$SESSION_ID" ]]; then
  unset ACTIVE_SESSION_ID
  echo "‚úì ACTIVE_SESSION_ID cleared"
else
  echo "  (No matching active session variable found)"
fi
echo

echo "üóÑÔ∏è  Moving to archive..."
"$SCRIPT_DIR/archive-session.sh" "$SESSION_ID"
echo

echo "‚úÖ Session closed successfully"
echo
echo "Active sessions remaining:"
ls -1 sessions/ | grep "^session-" || echo "  (none)"
